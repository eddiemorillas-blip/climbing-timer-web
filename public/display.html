<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timer Display</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      color: #fff;
    }
    .display-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }
    /* Timer section - 70% */
    .timer-section {
      flex: 7;
      min-height: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    /* Climber section - 30% */
    .climber-section {
      flex: 3;
      min-height: 0;
      background: #111;
      padding: 0.5vh 0.5vw;
      display: flex;
      align-items: stretch;
      overflow: hidden;
    }
    .tabular-nums { font-variant-numeric: tabular-nums; }

    /* Timer display */
    #timeDisplay {
      font-family: 'Roboto Mono', 'Consolas', 'Menlo', 'Monaco', monospace;
      font-size: 28vw;
      line-height: 0.9;
      letter-spacing: 0.02em;
    }
    #phaseLabel {
      font-size: 4vw;
      font-weight: 600;
      margin-bottom: 1vw;
    }

    /* Phase colors */
    .phase-climb { color: #22c55e; }
    .phase-transition { color: #f59e0b; }
    .phase-stopped { color: #6b7280; }

    /* Climber Grid */
    .climber-grid {
      display: grid;
      gap: 0.5vh;
      width: 100%;
      height: 100%;
    }
    .climber-cell {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5vh;
      padding: 0.3vh 0.5vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
      min-height: 0;
    }
    .boulder-header {
      font-size: 1.2vh;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.5);
    }
    .category-name {
      font-size: 1.5vh;
      color: rgba(255, 255, 255, 0.7);
    }
    .climber-name {
      font-weight: 700;
      line-height: 1;
    }

    /* Dynamic font sizing based on number of categories */
    .climber-grid[data-categories="1"] .climber-name { font-size: 8vh; }
    .climber-grid[data-categories="2"] .climber-name { font-size: 5vh; }
    .climber-grid[data-categories="3"] .climber-name { font-size: 3.5vh; }
    .climber-grid[data-categories="4"] .climber-name { font-size: 2.5vh; }

    /* Empty cell styling */
    .climber-cell-empty {
      background: rgba(255, 255, 255, 0.02);
      border-color: rgba(255, 255, 255, 0.1);
    }
    .climber-cell-empty .climber-name {
      color: rgba(255, 255, 255, 0.2);
    }

    /* Fullscreen button */
    .fullscreen-btn {
      position: fixed;
      top: 1vw;
      right: 1vw;
      padding: 0.8vw 1.5vw;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 0.5vw;
      color: white;
      font-size: 1.2vw;
      cursor: pointer;
      z-index: 1000;
      transition: opacity 0.3s;
    }
    .fullscreen-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    /* Hide button in fullscreen after a delay */
    :fullscreen .fullscreen-btn {
      opacity: 0;
    }
    :fullscreen .fullscreen-btn:hover {
      opacity: 1;
    }

    /* Connection indicator */
    .connection-indicator {
      position: fixed;
      top: 1vw;
      left: 1vw;
      font-size: 1vw;
      opacity: 0.5;
      z-index: 1000;
    }
    .status-dot {
      display: inline-block;
      width: 0.8vw;
      height: 0.8vw;
      border-radius: 50%;
      margin-right: 0.5vw;
    }
    .status-connected { background-color: #22c55e; }
    .status-disconnected { background-color: #ef4444; }
  </style>
</head>
<body>
  <!-- Fullscreen Button -->
  <button class="fullscreen-btn" id="fullscreenBtn">Fullscreen</button>

  <!-- Connection Status -->
  <div class="connection-indicator">
    <span class="status-dot status-disconnected" id="statusDot"></span>
    <span id="connectionStatus">Connecting...</span>
  </div>

  <div class="display-container">
    <!-- Timer Section (70%) -->
    <div class="timer-section">
      <div id="phaseLabel" class="phase-stopped">Ready</div>
      <div id="timeDisplay" class="tabular-nums">04:00</div>
    </div>

    <!-- Climber Section (30%) -->
    <div class="climber-section">
      <div id="climberGrid" class="climber-grid" data-categories="0">
        <!-- Dynamically populated -->
      </div>
    </div>
  </div>

  <!-- Socket.IO Client Library -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    // --- Fullscreen ---
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error('Fullscreen error:', err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // --- Socket.IO Connection ---
    const socket = io();

    socket.on('connect', () => {
      document.getElementById('statusDot').className = 'status-dot status-connected';
      document.getElementById('connectionStatus').textContent = 'Connected';
    });

    socket.on('disconnect', () => {
      document.getElementById('statusDot').className = 'status-dot status-disconnected';
      document.getElementById('connectionStatus').textContent = 'Disconnected';
    });

    // --- App State ---
    const state = {
      phase: 'stopped',
      remaining: 240,
      categories: []
    };

    const fmt = (s) => {
      s = Math.max(0, Math.floor(s));
      const m = Math.floor(s / 60), r = s % 60;
      return String(m).padStart(2, '0') + ':' + String(r).padStart(2, '0');
    };

    function updateDisplay() {
      document.getElementById('timeDisplay').textContent = fmt(state.remaining);
      const phaseLabel = document.getElementById('phaseLabel');
      if (state.phase === 'stopped') {
        phaseLabel.textContent = 'Ready';
        phaseLabel.className = 'phase-stopped';
      } else if (state.phase === 'climb') {
        phaseLabel.textContent = 'CLIMB';
        phaseLabel.className = 'phase-climb';
      } else {
        phaseLabel.textContent = 'TRANSITION';
        phaseLabel.className = 'phase-transition';
      }
    }

    // --- Completion Tracking Helpers ---
    function isClimberCompleted(category, climberName) {
      const progress = category.climberProgress?.[climberName] || [];
      return progress.length >= 4 && [1, 2, 3, 4].every(b => progress.includes(b));
    }

    function getActiveClimberCount(category) {
      const climbers = category.boulders[0]?.climbers || [];
      return climbers.filter(name => !isClimberCompleted(category, name)).length;
    }

    // --- Listen for state updates from server ---
    socket.on('timer-sync', (serverState) => {
      state.phase = serverState.phase;
      state.remaining = serverState.remaining;
      updateDisplay();
    });

    socket.on('categories-sync', (categories) => {
      state.categories = categories || [];
      renderClimberGrid();
    });

    function renderClimberGrid() {
      const grid = document.getElementById('climberGrid');

      if (state.categories.length === 0) {
        grid.innerHTML = '<div class="text-center text-gray-500 text-2xl w-full">No categories configured</div>';
        return;
      }

      // Find which boulders have climbers
      const activeBoulderIds = new Set();
      state.categories.forEach(category => {
        category.boulders.forEach(boulder => {
          if (boulder.climbers && boulder.climbers.length > 0) {
            activeBoulderIds.add(boulder.boulderId);
          }
        });
      });

      if (activeBoulderIds.size === 0) {
        grid.innerHTML = '<div class="text-center text-gray-500 text-2xl w-full">No climbers imported</div>';
        return;
      }

      grid.setAttribute('data-categories', state.categories.length);

      // Set dynamic column count
      const sortedBoulderIds = [...activeBoulderIds].sort((a, b) => a - b);
      grid.style.gridTemplateColumns = `repeat(${sortedBoulderIds.length}, 1fr)`;
      grid.style.gridTemplateRows = `repeat(${state.categories.length}, 1fr)`;

      let html = '';

      for (let categoryIndex = 0; categoryIndex < state.categories.length; categoryIndex++) {
        const category = state.categories[categoryIndex];
        const activeCount = getActiveClimberCount(category);

        for (const boulderId of sortedBoulderIds) {
          const boulder = category.boulders.find(b => b.boulderId === boulderId);
          const isSkipped = boulder?.skipNext === true;
          const hasStarted = boulder?.hasStarted === true;
          const climber = hasStarted && !isSkipped ? boulder?.climbers?.[boulder?.currentClimberIndex || 0] : null;
          const climberCount = boulder?.climbers?.length || 0;

          const allDone = activeCount === 0 && climberCount > 0;
          const isEmpty = !climber && !allDone;

          html += `
            <div class="climber-cell ${isEmpty ? 'climber-cell-empty' : ''}">
              <div class="boulder-header">Boulder ${boulderId}</div>
              <div class="category-name">${category.name}</div>
              <div class="climber-name">${allDone ? 'DONE' : (climber || 'â€”')}</div>
            </div>
          `;
        }
      }

      grid.innerHTML = html;
    }

    // Init
    updateDisplay();
  </script>
</body>
</html>
